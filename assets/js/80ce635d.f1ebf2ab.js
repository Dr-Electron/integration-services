"use strict";(self.webpackChunkiota_wiki=self.webpackChunkiota_wiki||[]).push([[3767],{67370:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return c},default:function(){return u}});var o=n(87462),r=n(63366),i=(n(67294),n(3905)),a=["components"],l={},s="Docker",p={unversionedId:"installation/docker",id:"installation/docker",isDocsHomePage:!1,title:"Docker",description:"1. Copy .env file",source:"@site/external/integration-services/documentation/docs/installation/docker.md",sourceDirName:"installation",slug:"/installation/docker",permalink:"/integration-services/integration-services/installation/docker",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Overview",permalink:"/integration-services/integration-services/installation/overview"},next:{title:"Docker Compose",permalink:"/integration-services/integration-services/installation/docker_compose"}},c=[{value:"1. Copy .env file",id:"1-copy-env-file",children:[],level:2},{value:"2. Local Development",id:"2-local-development",children:[{value:"1. Run MongoDB",id:"1-run-mongodb",children:[],level:3},{value:"2. Run the API",id:"2-run-the-api",children:[],level:3}],level:2},{value:"3. Run all using Docker",id:"3-run-all-using-docker",children:[],level:2},{value:"4. API Key",id:"4-api-key",children:[],level:2}],d={toc:c};function u(e){var t=e.components,n=(0,r.Z)(e,a);return(0,i.kt)("wrapper",(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"docker"},"Docker"),(0,i.kt)("h2",{id:"1-copy-env-file"},"1. Copy .env file"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"This section must be done for local development start or when starting via docker.")),(0,i.kt)("p",null,"Copy the ",(0,i.kt)("inlineCode",{parentName:"p"},"./api/.env-example")," and rename it to ",(0,i.kt)("inlineCode",{parentName:"p"},"./api/.env"),"\nIt contains predefined variables and some with secret values starting with < and ending with > like for instance: ",(0,i.kt)("inlineCode",{parentName:"p"},"<db-user>")),(0,i.kt)("p",null,"Define for the following variables a private value:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"MONGO_INITDB_ROOT_USERNAME, MONGO_INITDB_ROOT_PASSWORD, DATABASE_URL, SERVER_SECRET\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"!! For now leave the ",(0,i.kt)("inlineCode",{parentName:"p"},"SERVER_IDENTITY")," blank or remove the complete line. !!")),(0,i.kt)("p",null,"The config should like following: (But please don't use the following values for username, password and secret in your env config.) The server secret is used to encrypt for instance the private key of the server identity but also to sign JWTs so it should be secure. "),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Important: The SERVER_SECRET has to have a length of 32 characters!!")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"PORT=3000\nAPI_VERSION=v1\nIOTA_PERMA_NODE=https://chrysalis-chronicle.iota.org/api/mainnet/\nIOTA_HORNET_NODE=https://chrysalis-nodes.iota.org:443\nNETWORK=main\nEXPLORER=https://explorer.iota.org/mainnet/transaction\nDATABASE_NAME=integration-services\nMONGO_INITDB_ROOT_USERNAME=root\nMONGO_INITDB_ROOT_PASSWORD=rootpassword\nDATABASE_URL=mongodb://root:rootpassword@0.0.0.0:27017\nSERVER_SECRET=PpKFhPKJY2efTsN9VkB7WNtYUhX9Utaa\n")),(0,i.kt)("p",null,"Make sure you use the same username and password for the ",(0,i.kt)("inlineCode",{parentName:"p"},"DATABASE_URL")," as in ",(0,i.kt)("inlineCode",{parentName:"p"},"MONGO_INITDB_ROOT_USERNAME")," & ",(0,i.kt)("inlineCode",{parentName:"p"},"MONGO_INITDB_ROOT_PASSWORD"),"."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"If you run the api through docker you need to set the ip of the machine the database is running on if you use ",(0,i.kt)("inlineCode",{parentName:"p"},"npm run start")," you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"0.0.0.0")," as host!")),(0,i.kt)("h2",{id:"2-local-development"},"2. Local Development"),(0,i.kt)("p",null,"For local development it makes sense to only use docker for the database and use nodejs to run the api."),(0,i.kt)("h3",{id:"1-run-mongodb"},"1. Run MongoDB"),(0,i.kt)("p",null,"1.1  Change the directory to the ",(0,i.kt)("inlineCode",{parentName:"p"},"/api")," folder und use the following command: ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose up -d mongodb_container")," only the mongodb will be started using docker."),(0,i.kt)("p",null,"1.2. Check the docker container\nUse ",(0,i.kt)("inlineCode",{parentName:"p"},"docker ps")," to check whether the container is running. It should output something like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                      NAMES\neceaab9343eb   mongo:latest   "docker-entrypoint.s\u2026"   7 seconds ago   Up 7 seconds   0.0.0.0:27017->27017/tcp   api_mongodb_1\n')),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"You can connect to the api via clients like ",(0,i.kt)("inlineCode",{parentName:"p"},"MongoDB Compass")," by using the defined connection url of the database like for instance ",(0,i.kt)("inlineCode",{parentName:"p"},"mongodb://root:rootpassword@0.0.0.0:27017"),"!")),(0,i.kt)("h3",{id:"2-run-the-api"},"2. Run the API"),(0,i.kt)("p",null,"2.1. Make sure you are in the ",(0,i.kt)("inlineCode",{parentName:"p"},"/api")," folder and use the following commands:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"npm install     # Install dependencies\nnpm run keygen  # Generate root identity: output on SERVER_ENTITY file\nnpm run start   # Run server\n")),(0,i.kt)("p",null,"If it was the first time the api is started, no ",(0,i.kt)("inlineCode",{parentName:"p"},"SERVER_IDENTITY")," is defined since it was left blank previously. The api should log a newly generated identity id which needs to be used as server identity as following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Successfully connected to mongodb\nCreate identity...\n==================================================================================================\n== Store this identity in the as ENV var: did:iota:BfGtLdthmzrUdgYptrZgnC4amXZBZ2C2xQMVM7Bb1cZs ==\n==================================================================================================\nAdd server id as trusted root...\nGenerate key collection...\nSet server identity as verified...\nSetup Done!\nPlease store the generated server identity as environment variable.\nLike: SERVER_IDENTITY=did:iota:BfGtLdthmzrUdgYptrZgnC4amXZBZ2C2xQMVM7Bb1cZs\n")),(0,i.kt)("p",null,"2.2. Copy the ",(0,i.kt)("inlineCode",{parentName:"p"},"SERVER_IDENTITY")," into the .env file."),(0,i.kt)("p",null,"2.3. Run the api again using ",(0,i.kt)("inlineCode",{parentName:"p"},"npm run start")),(0,i.kt)("p",null,"It should log that the api was started like following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Started API Server on port 3000\nSuccessfully connected to mongodb\n")),(0,i.kt)("h2",{id:"3-run-all-using-docker"},"3. Run all using Docker"),(0,i.kt)("p",null,"3.1. Start the api"),(0,i.kt)("p",null,"The api can also be run using docker therefor use the following command:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose up -d")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"!! Make sure the correct ip for the mongodb is set so the docker instance of the api is able to find the mongodb instance. Normally it should be the ip of the machine instaed of 0.0.0.0 !!")),(0,i.kt)("p",null,"If it was the first time the api is started, no ",(0,i.kt)("inlineCode",{parentName:"p"},"SERVER_IDENTITY")," is defined since it was left blank previously. The api should log a newly generated identity id which needs to be used as server identity as following:"),(0,i.kt)("p",null,"You can check the logs using: ",(0,i.kt)("inlineCode",{parentName:"p"},"docker logs api_ensuresec_api_1")," or using the container id like ",(0,i.kt)("inlineCode",{parentName:"p"},"docker logs <container-id>")," by replacing ",(0,i.kt)("inlineCode",{parentName:"p"},"<container-id>")," with the actual id."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Successfully connected to mongodb\nCreate identity...\n==================================================================================================\n== Store this identity in the as ENV var: did:iota:BfGtLdthmzrUdgYptrZgnC4amXZBZ2C2xQMVM7Bb1cZs ==\n==================================================================================================\nAdd server id as trusted root...\nGenerate key collection...\nSet server identity as verified...\nSetup Done!\nPlease store the generated server identity as environment variable.\nLike: SERVER_IDENTITY=did:iota:BfGtLdthmzrUdgYptrZgnC4amXZBZ2C2xQMVM7Bb1cZs\n")),(0,i.kt)("p",null,"3.2. Copy the ",(0,i.kt)("inlineCode",{parentName:"p"},"SERVER_IDENTITY")," into the .env file."),(0,i.kt)("p",null,"3.3. Run the docker again using ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose up -d")),(0,i.kt)("p",null,"The docker container should log that the api was started like following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"Started API Server on port 3000\nSuccessfully connected to mongodb\n")),(0,i.kt)("p",null,"There should be now 2 docker container available check it using: `docker ps``"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'CONTAINER ID   IMAGE               COMMAND                  CREATED         STATUS         PORTS                      NAMES\n086e1549bdb3   api_ensuresec_api   "docker-entrypoint.s\u2026"   6 seconds ago   Up 5 seconds   0.0.0.0:3000->3000/tcp     api_ensuresec_api_1\n0bd35f3d5fc5   mongo:latest        "docker-entrypoint.s\u2026"   7 seconds ago   Up 6 seconds   0.0.0.0:27017->27017/tcp   api_mongodb_container_1\n')),(0,i.kt)("h2",{id:"4-api-key"},"4. API Key"),(0,i.kt)("p",null,"The api supports an optional api-key which can be used to filter requests which do not know about the right key. If the key is not added or is set as an empty string the api-key won't be considered by the api. To force a check for the api-key it can be added by adding the env variable ",(0,i.kt)("inlineCode",{parentName:"p"},"API_KEY")," to the .env file, like for instance:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"API_KEY=SAMPLE-API-KEY\n")),(0,i.kt)("p",null,"In this case all request must have the specified api-key as ",(0,i.kt)("inlineCode",{parentName:"p"},"?api-key=SAMPLE-API-KEY")," query parameter like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"localhost:3000/api/v1/verification/latest-document/did:iota:2k7Spwr9yFfCTgGPArucUg3h89W6kidjqBBMMKMW4C9r?api-key=SAMPLE-API-KEY\n")))}u.isMDXComponent=!0},3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return k}});var o=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),k=r,h=u["".concat(s,".").concat(k)]||u[k]||d[k]||i;return n?o.createElement(h,a(a({ref:t},c),{},{components:n})):o.createElement(h,a({ref:t},c))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,a=new Array(i);a[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,a[1]=l;for(var p=2;p<i;p++)a[p]=n[p];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);